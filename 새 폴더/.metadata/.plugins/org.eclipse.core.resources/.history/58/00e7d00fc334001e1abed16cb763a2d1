getCommentList(bnoVal);

let lastid = 19; // ë§ˆì§€ë§‰ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ div id
let isHandlingScroll = false; // ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ë¥¼ ìœ„í•œ ë³€ìˆ˜
const qty = 20; // í•œ ë²ˆì— ìƒì„±í•  ë°•ìŠ¤ ê°œìˆ˜
let pag = 2; // ë¶ˆëŸ¬ì˜¬ ì‹œì‘ í˜ì´ì§€

function handleScroll() {
  if (isHandlingScroll) {
    return; // ì´ë¯¸ ì‹¤í–‰ ì¤‘ì¸ ê²½ìš°, ë” ì´ìƒì˜ ì²˜ë¦¬ë¥¼ í•˜ì§€ ì•Šê³  ì¢…ë£Œ
  }
  isHandlingScroll = true; // ì‹¤í–‰ ì¤‘ í‘œì‹œ
  let myDiv = document.getElementById('box' + lastid);
  if (myDiv) {
    let rect = myDiv.getBoundingClientRect();
    let windowHeight = window.innerHeight || document.documentElement.clientHeight;
    let viewportY = (windowHeight / 4) * 3;
    if (rect.top + rect.height / 2 < viewportY) {
      console.log('div' + lastid + 'ê°€ í™”ë©´ì˜ ì¤‘ì•™ë³´ë‹¤ ìœ„ì— ìˆìŠµë‹ˆë‹¤.');
      let keyword = document.getElementById("searchInput").getAttribute("data-keyword"); // ê²€ìƒ‰ì–´ ê°€ì ¸ì˜¤ê¸°
      getBoardList(pag,keyword,qty).then((BoardUserDTO)=>{
        if (BoardUserDTO === null || BoardUserDTO === undefined || BoardUserDTO.length === 0) {
          console.log("BUDTOê°’ì´ ì—†ìŠµë‹ˆë‹¤.");
          return;
        }else{
          for(let i = 0; i<BoardUserDTO.length ; i++){
            let previousDiv = document.getElementById(`box${lastid}`);//ë§ˆì§€ë§‰ìœ¼ë¡œ ë§Œë“¤ì–´ì§„ div
            
            const bvo = BoardUserDTO[i].bvo;
            const uvo = BoardUserDTO[i].uvo;
            let fvo;
            if (BoardUserDTO[i].flist === undefined || BoardUserDTO[i].flist.length  === 0) { //ì‚¬ì§„ ìˆë‹¤ë©´ ì²«ë²ˆì§¸ì‚¬ì§„ ì—†ë‹¤ë©´ null
              fvo = null;
            } else {
              fvo = BoardUserDTO[i].flist[0];
            }
    
            //ì‚¬ì§„ ìœ ë¬´ ë”°ë¼ midBoxë³€ê²½
            if (fvo === null) {
              midBox = `<div class="titleBox midBox" >
                ${bvo.title}
              </div>`;
            } else {
              midBox = `<img class="thumbnail midBox" src="/upload/${fvo.saveDir.replace(/\\/g, '/')}/${fvo.uuid}_${fvo.fileName}" alt="ì´ë¯¸ì§€" >`;
            }

            //ì¢‹ì•„ìš”
            let str = bvo.likeUser; //ì¢‹ì•„ìš” ë¬¸ìì—´(#aa#bb#cc)
            let likeUserArr = []; //ì¢‹ì•„ìš” ë°°ì—´(aa, bb, cc)
            let likeCount = 0; //ì¢‹ì•„ìš” ê°œìˆ˜
            let isLike = false; //ì¢‹ì•„ìš” ëˆŒë¦¼ìƒíƒœ
            let buttonStr = ""; //ë§Œë“¤ì–´ì§ˆ ì¢‹ì•„ìš” ë²„íŠ¼
            //ì¢‹ì•„ìš” ë¬¸ìì—´ì„ ì¢‹ì•„ìš” ë°°ì—´ë¡œ ë³€ê²½
            if (str !== null) {
              likeUserArr = str.split('#').filter(function (item) {
                return item !== '';
              });
            }
            //ì¢‹ì•„ìš” ëˆŒë €ì—ˆë‚˜?
            for (let j = 0; j < likeUserArr.length; j++) {
              let likeUser = likeUserArr[j];
              if (likeUser === sesId) {
                isLike = true;
                break;
              }
              likeCount++;
            }
            //ì•Œë§ì€ ì¢‹ì•„ìš” ë²„íŠ¼ ìƒì„±
            if (bvo.id != sesId) {
              if (isLike) {
                buttonStr = `<i class="bi bi-heart-fill hateBtn"></i>`;
              } else {
                buttonStr = ` <i class="bi bi-heart likeBtn"></i>`;
              }
            }

            //pp divìƒì„±
            previousDiv.insertAdjacentHTML('afterend', `
            <div class="pp" id="box${lastid+1}">
              <div class="contentBox" data-bno="${bvo.bno}" data-title="${bvo.title}" data-boardid="${bvo.id}">
                ${midBox}
                <div class="overlayBox" onclick="window.location.href = '/board/detail?bno=${bvo.bno}';"></div>
                <div class="profile hid hiddenText">
                  <a href="/member/mypage?id=${bvo.id}"><img alt="" src="/upload/profile/${uvo.imgFile}" style="width: 30px; height: 30px;"></a>
                  <a href="/member/mypage?id=${bvo.id}">${uvo.name}</a>
                </div>
                <div class="minBox">
                  <span class="tspan hid hiddenText">${likeCount}</span>
                  ${buttonStr}
              </div>
              </div>
            </div>
            `);

            console.log('div' + lastid + 'ìƒì„±!');
            lastid++;

          }
          pag ++;
          console.log("ë‹¤ìŒ í˜ì´ì§€: " + pag);
          isHandlingScroll = false; // ì‹¤í–‰ ì¢…ë£Œ í‘œì‹œ

        }
        toggleClass();
      })
      
    } else {
      isHandlingScroll = false; // ì‹¤í–‰ ì¢…ë£Œ í‘œì‹œ
    }
  } else {
    console.log('ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
  }
}



// ìŠ¤í¬ë¡¤ ì´ë²¤íŠ¸ì— handleScroll í•¨ìˆ˜ë¥¼ ì—°ê²°í•©ë‹ˆë‹¤.
window.addEventListener('scroll', handleScroll);

// í˜ì´ì§€All ê°€ì§€ê³ ì˜¤ê¸°
async function getBoardList(pageNo, keyword, qty) {
  console.log("ê°€ì§€ê³ ì˜¨ í˜ì´ì§€: " + pageNo);
  try {
    const resp = await fetch('/board/glist/' + pageNo + '-' + keyword +'-'+qty);
    const result = await resp.json();
    return result;
  } catch (err) {
    console.log(err);
  }

}


//í´ë¦­ì´ë²¤íŠ¸
document.addEventListener('click', (e) => {
  console.log('í´ë¦­');
  if (e.target.classList.contains('likeBtn')){ //ì¢‹ì•„ìš”
    console.log('ì¢‹ì•„ìš”');

    const div = e.target.closest('.contentBox');
    const bno = div.dataset.bno;
    const title = div.dataset.title;
    const boardid = div.dataset.boardid;

    likeToggle(e, bno);
    const pushType = 0; //ì¢‹ì•„ìš”ëŠ” 0 ,ëŒ“ê¸€ì€ 1
    putAlarm(bno, title, boardid, sesId, sesName, pushType);

  }else if (e.target.classList.contains('hateBtn')){//ì¢‹ì•„ìš” ì·¨ì†Œ
    console.log('ì¢‹ì•„ìš” ì·¨ì†Œ');

    const div = e.target.closest('.contentBox');
    const bno = div.dataset.bno;

    likeToggle(e, bno);
  }

});

//ì¢‹ì•„ìš” í† ê¸€
function likeToggle(e,bno){
  e.target.classList.toggle('likeBtn');
  e.target.classList.toggle('hateBtn');
  e.target.classList.toggle('bi-heart-fill');
  e.target.classList.toggle('bi-heart');

  DBlikeToggle(bno, sesId).then(result => {
    let tspan = e.target.closest('div').querySelector('.tspan');
    tspan.textContent = result;
  });
}

// ì¢‹ì•„ìš” ë³€í™˜
async function DBlikeToggle(bno, sesId) {
  try {
    const url = '/board/likeToggle/' + bno + "/" + sesId;
    const config = { method: 'put' };
    const resp = await fetch(url, config);
    const result = await resp.text();
    return result;
  } catch (error) {
    console.log(error);
  }
}

//ë§ˆìš°ìŠ¤ ì˜¤ë²„ ì´ë²¤íŠ¸
function toggleClass() {
  let contentBoxes = document.querySelectorAll('.contentBox');
  console.log(contentBoxes);

  contentBoxes.forEach((contentBox) => {
    // ë§ˆìš°ìŠ¤ ì˜¬ë ¸ì„ ë•Œ 
    contentBox.addEventListener('mouseenter', (e) => {
      const target =  e.currentTarget;
      target.querySelectorAll('.hid').forEach((element) => {
        element.classList.remove('hiddenText');
      });
    });

    // ë§ˆìš°ìŠ¤ ë‚˜ê°”ì„ ë•Œ
    contentBox.addEventListener('mouseleave', (e) => {
      const target =  e.currentTarget;
      target.querySelectorAll('.hid').forEach((element) => {
        element.classList.add('hiddenText');
      });
    });
  });
}

toggleClass();

// ì•ŒëŒ DBì— ì €ì¥
async function putAlarm(bno, title, boardid, sesId, sesName, pushType) {
  try {
    const url = "/alarm/push";
    const data = {
      bno: bno,
      title: title,
      id: boardid,
      pushId: sesId,
      pushName: sesName,
      pushType: pushType
    };
    const config = {
      method: 'post',
      body: JSON.stringify(data),
      headers: {
        'Content-Type': 'application/json'
      }
    };
    const resp = await fetch(url, config);
    const result = await resp.text();
    return result;
  } catch (error) {
    console.log(error);
  }
}

// //ì‹ ê³ 
// document.getElementById('listBlackBtn').addEventListener('click',()=>{
//   let bno = document.getElementById('listBlackBtn').dataset.id;
//   listBlackPlus(bno);
// })
// async function listBlackPlus(bno) {
//   try {
//     const url = '/board/listBlackPlus/' + bno;
//     const config = { method: 'put' };
//     const resp = await fetch(url, config);
//     const result = await resp.text();
//     return result;
//   } catch (error) {
//     console.log(error);
//   }
// }





//ëŒ“ê¸€

const emojiList = ['ğŸ˜ƒ', 'ğŸ‘', 'â¤ï¸', 'ğŸ˜Š', 'ğŸ‰'];


document.getElementById('toggleComment').addEventListener('click', () => {
    // commentContainer ìš”ì†Œì— ëŒ€í•œ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
    const commentContainer = document.getElementById('commentContainer');
    const tH1 = document.getElementById('tH1');
    // commentContainer ìš”ì†Œì˜ ê°€ì‹œì„±(visibility) í† ê¸€
    if (commentContainer.style.display === 'none') {
        tH1.innerText= '';
        tH1.innerHTML= 'ëŒ“ê¸€ â–½';
        commentContainer.style.display = 'block';
    } else {
        tH1.innerText= '';
        tH1.innerHTML= 'ëŒ“ê¸€ â–·';
        commentContainer.style.display = 'none';
    }
});

const likeImg = document.getElementById('likeImg');
let liked = false;

likeImg.addEventListener('click', () => {
  liked = !liked; // í´ë¦­í•  ë•Œë§ˆë‹¤ liked ë³€ìˆ˜ë¥¼ í† ê¸€í•©ë‹ˆë‹¤.

  // liked ë³€ìˆ˜ì˜ ìƒíƒœì— ë”°ë¼ í•˜íŠ¸ ì´ëª¨ì§€ì˜ ìƒ‰ìƒ í´ë˜ìŠ¤ë¥¼ toggleí•©ë‹ˆë‹¤.
  if (liked) {
    likeImg.innerText = 'â¤ï¸';
    likeImg.classList.add('red-heart'); // red-heart í´ë˜ìŠ¤ ì¶”ê°€
  } else {
    likeImg.innerText = 'ğŸ¤';
    likeImg.classList.remove('red-heart'); // red-heart í´ë˜ìŠ¤ ì œê±°
  }
});

async function postCommentToServer(cmtData) {
    try {
        const url = '/comment/post';
        const config = {
            method: "post",
            headers: {
                'content-type': 'application/json; charset=utf-8'
            },
            body: JSON.stringify(cmtData)
        };
        const resp = await fetch(url, config);
        const result = await resp.text(); //isOK
        return result;
    } catch (err) {
        console.log(err);
    }
}
//ëŒ“ê¸€ë“±ë¡
document.getElementById('cmtPostBtn').addEventListener('click', (e) => {
    const cmtText = document.getElementById('floatingInputGroup1').value;
    const bno = e.target.dataset.bno; // data-bno ê°’ ê°€ì ¸ì˜¤ê¸°
    const title = e.target.dataset.title; // data-title ê°’ ê°€ì ¸ì˜¤ê¸°
    const boardid = e.target.dataset.boardid; // data-boardid ê°’ ê°€ì ¸ì˜¤ê¸°
    const cmtid=e.target.dataset.cmtid;


   
    console.log(cmtText);
    if (cmtText === "" || cmtText === null) {
        alert("ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”");
        document.getElementById('floatingInputGroup1').focus();
        return false;
    } else {
        let cmtData = {
            bno: bnoVal,
            id: cmtid,
            ccontent: cmtText
        };
        console.log(cmtData);
        const pushType = 1;
        putAlarm(bno, title, boardid, sesId, sesName, pushType);
        postCommentToServer(cmtData).then(result => {
            //isOk í™•ì¸ ë°ì´í„°
            if (result > 0) {
                alert("ëŒ“ê¸€ ë“±ë¡ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");
                getCommentList(cmtData.bno);
                document.getElementById('floatingInputGroup1').value = '';
            }
        });
    }
});

document.getElementById('emojiBtn').addEventListener('click', () => {
    const emojiContainer = document.getElementById('emojiContainer'); // ì´ëª¨í‹°ì½˜ ëª©ë¡ì„ ë‹´ì„ ìš”ì†Œ



    emojiContainer.innerHTML = ''; // ëª©ë¡ì„ ë¹„ì›ë‹ˆë‹¤
    emojiList.forEach(emoji => {
        const emojiButton = document.createElement('button');
        emojiButton.classList.add('emojiItem');
        emojiButton.textContent = emoji;

        emojiButton.addEventListener('click', () => {
            const cmtText = document.getElementById('floatingInputGroup1');
            cmtText.value += emoji; // ì„ íƒí•œ ì´ëª¨í‹°ì½˜ì„ ëŒ“ê¸€ í…ìŠ¤íŠ¸ í•„ë“œì— ì¶”ê°€í•©ë‹ˆë‹¤
            emojiContainer.innerHTML = ''; // ì´ëª¨í‹°ì½˜ ëª©ë¡ì„ ìˆ¨ê¹ë‹ˆë‹¤
        });
        emojiContainer.appendChild(emojiButton);
    });
});

async function spreadCommentFromServer(bno) {
    console.log(bno);
    try {
        const resp = await fetch('/comment/' + bno);
        const result = await resp.json();
        return result;
    } catch (err) {
        console.log(err);
    }
}

function getCommentList(bno){
  spreadCommentFromServer(bno).then((result)=>{
    

    const ul=document.getElementById('cmtListArea');
    if(result!=''||result!=null){
      ul.innerHTML='';
      const ulist=result.ulist;
      const clist=result.clist;
      let i=0;
      for(let cvo of clist){
        let uvo=ulist[i];
        console.log(cvo);
        console.log(uvo);

        
        const li = document.createElement('li');
        li.setAttribute('data-cno', cvo.cno);

        const div1 = document.createElement('div');
        const link = document.createElement('a');
        link.href = `/member/mypage?id=${cvo.id}`;

        const idSpan = document.createElement('span');
        const imgspan=document.createElement('img');
        imgspan.src=`/upload/profile/${uvo.imgFile}`;
        imgspan.classList.add('profilecss');
        idSpan.classList.add('idbox');
        idSpan.textContent = uvo.name;
        link.appendChild(imgspan);
        link.appendChild(idSpan);
        div1.appendChild(link);

        const contentSpan = document.createElement('span');
        contentSpan.textContent = cvo.ccontent;
        contentSpan.classList.add('contentspan');
        div1.appendChild(contentSpan);
        li.appendChild(div1);

        const div2 = document.createElement('div');
        div2.classList.add('datebox');
        const dateSpan = document.createElement('span');
        dateSpan.textContent = cvo.regDate;
        div2.appendChild(dateSpan);

        const menuSpan = document.createElement('span');
        menuSpan.classList.add('material-symbols-outlined');
        menuSpan.classList.add('menu');
        menuSpan.textContent = 'more_horiz';
        menuSpan.addEventListener('click', () => {
          const buttonDiv = div2.querySelector('.button-div');

          // Toggle visibility of the buttons by adding/removing a class
          if (buttonDiv) {
            buttonDiv.remove();
          } else {
            const newDiv = document.createElement('div');
            newDiv.classList.add('button-div');
            if (cvo.id === sesVal) {
              console.log('ì´ê²ƒì€ ì œ ëŒ“ê¸€ì…ë‹ˆë‹¤.');
              const modBtn = document.createElement('button');
              modBtn.type = 'button';
              modBtn.classList.add('modBtn');
              modBtn.classList.add('btncss');
              modBtn.textContent = 'ìˆ˜ì •';
              newDiv.appendChild(modBtn);

              const delBtn = document.createElement('button');
              delBtn.type = 'button';
              delBtn.classList.add('delBtn');
              delBtn.classList.add('btncss');
              delBtn.textContent = 'ì‚­ì œ';
              newDiv.appendChild(delBtn);
            } else {
              console.log('ë‚´ ëŒ“ê¸€ ì•„ë‹˜',cvo.id, sesVal);
              const reportBtn = document.createElement('button');
              reportBtn.type = 'button';
              reportBtn.classList.add('blackBtn');
              reportBtn.classList.add('btncss');
              reportBtn.textContent = 'ì‹ ê³ ';
              newDiv.appendChild(reportBtn);
            }

            div2.appendChild(newDiv);
          }
        });
        div2.appendChild(menuSpan);

        li.appendChild(div2);

        ul.appendChild(li);
        document.getElementById('tH1').innerText=`ëŒ“ê¸€ ${i+1}ê°œ`;
        i++;
      }
    } else {
      // ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ëŠ” ê²½ìš°
      let li = `<li>ë“±ë¡ëœ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤.</li>`;
      ul.innerHTML += li;
    }
  });
}





//ëŒ“ê¸€ìˆ˜ì •
async function editCommentToServer(cmtDataMod) {
    try {
        const url = '/comment/' + cmtDataMod.cno;
        const config = {
            method: 'put',
            headers: {
                'content-type': 'application/json; charset=utf-8'
            },
            body: JSON.stringify(cmtDataMod)
        };
        const resp = await fetch(url, config);
        const result = await resp.text();
        return result;
    } catch (err) {
        console.log(err);
    }
}
//ëŒ“ê¸€ì‚­ì œ
async function removeCommentToServer(cno) {
    try {
        const url = '/comment/' + cno;
        const config = {
            method: 'delete'
        };
        const resp = await fetch(url, config);
        const result = await resp.text();
        return result;
    } catch (err) {
        console.log(err);
    }
}

document.addEventListener('click', e => {
    console.log(e.target);


    if (e.target.classList.contains('thImg')) {
        
      e.preventDefault();
  
      // í´ë¦­ëœ thumb ì—˜ë¦¬ë¨¼íŠ¸ì˜ ID ê°€ì ¸ì˜¤ê¸°
      const clickedThumbID = e.target.id;
        console.log(clickedThumbID);
      // thumb ì—˜ë¦¬ë¨¼íŠ¸ì˜ IDì™€ ì¼ì¹˜í•˜ëŠ” data-bs-slide-to ê°’ ì°¾ê¸°
      const slideToElements = document.querySelectorAll("[data-bs-slide-to]");
    console.log(slideToElements);
      let targetSlideTo;
      for (const slideToElement of slideToElements) {
        if (slideToElement.getAttribute("data-bs-slide-to") === clickedThumbID) {
          targetSlideTo = slideToElement;
          console.log(targetSlideTo);
          break;
        }
      }
  
      // ì°¾ì€ data-bs-slide-toì˜ li ì—˜ë¦¬ë¨¼íŠ¸ í´ë¦­ ì´ë²¤íŠ¸ ë°œìƒ ì‹œí‚¤ê¸°
      if (targetSlideTo) {
        targetSlideTo.click();
      }
    }


    if (e.target.classList.contains('modBtn')) {
        console.log("ìˆ˜ì •ë²„íŠ¼ í´ë¦­ì‹œ");
        //ë‚´ê°€ í´ë¦­í•œ ë²„íŠ¼ì˜ ëŒ“ê¸€ ë­‰ì¹˜
        
        let li = e.target.closest('li');
        let cnoVal = li.dataset.cno;
        let textContent = li.querySelector('.contentspan').textContent;
        console.log("cno / content   => " + cnoVal + "  " + textContent);
      //li.querySelector('.contentspan').innerHTML=`<input type="text" class="newcmt" value="${textContent}">`;
      if (!li.querySelector('.newcmt')) {
        li.querySelector('.contentspan').innerHTML = `<input type="text" class="newcmt" value="${textContent}">`;
      } else {
        // input ìš”ì†Œê°€ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê²½ìš°ì—ëŠ” ë³€ê²½ëœ ë‚´ìš©ì„ ì ìš©
        let newContent = li.querySelector('.newcmt').value;
        li.querySelector('.contentspan').textContent = newContent;
        let cmtDataMod = {
          cno: cnoVal,
          ccontent: newContent
      };
      console.log(cmtDataMod);
      //ì„œë²„ ì—°ê²°
      editCommentToServer(cmtDataMod).then(result => {
          if (parseInt(result) > 0) {
              alert('ëŒ“ê¸€ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
          getCommentList(bnoVal);
      });
      }  

      // let cmtDataMod = {
      //       cno: cnoVal,
      //       ccontent: textContent
      //   };
      //   console.log(cmtDataMod);
      //   //ì„œë²„ ì—°ê²°
      //   editCommentToServer(cmtDataMod).then(result => {
      //       if (parseInt(result) > 0) {
      //           alert('ëŒ“ê¸€ ìˆ˜ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
      //       }
      //       getCommentList(bnoVal);
      //   });
    } else if (e.target.classList.contains('delBtn')) {
        console.log("ì‚­ì œë²„íŠ¼ í´ë¦­ì‹œ");
        let li = e.target.closest('li');
        let cnoVal = li.dataset.cno;
        console.log(cnoVal);
        removeCommentToServer(cnoVal).then(result => {
            if (result > 0) {
                alert('ëŒ“ê¸€ ì‚­ì œê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
            getCommentList(bnoVal);
        });
    }
});

//ì•ŒëŒ
async function putAlarm(bno, title, boardid, sesId, sesName, pushType) {
    try {
      const url = "/alarm/push";
      const data = {
        bno: bno,
        title: title,
        id: boardid,
        pushId: sesId,
        pushName: sesName,
        pushType: pushType
      };
      const config = {
        method: 'post',
        body: JSON.stringify(data),
        headers: {
          'Content-Type': 'application/json'
        }
      };
      const resp = await fetch(url, config);
      const result = await resp.text();
      return result;
    } catch (error) {
      console.log(error);
    }
  }